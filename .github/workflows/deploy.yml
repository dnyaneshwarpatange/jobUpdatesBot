name: Deploy Bot
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~
            
            # --- SELF-HEALING SECTION ---
            # If folder exists BUT it is not a Git repo (missing .git), it is broken.
            # We delete it so we can start fresh.
            if [ -d "jobUpdatesBot" ] && [ ! -d "jobUpdatesBot/.git" ]; then
              echo "âš ï¸ Detected broken folder. Deleting to fix..."
              rm -rf jobUpdatesBot
            fi
            # ---------------------------

            # 1. Clone if missing
            if [ ! -d "jobUpdatesBot" ]; then
              echo "â¬‡ï¸ Cloning repository..."
              git clone https://github.com/dnyaneshwarpatange/jobUpdatesBot.git
            fi

            # 2. Enter folder
            cd jobUpdatesBot

            # 3. Pull latest changes
            echo "ğŸ”„ Pulling latest code..."
            git pull origin main

            # 4. Ensure Database Files Exist (Prevent Crash)
            if [ ! -f "sentJobs.json" ]; then
              echo "ğŸ“„ Creating sentJobs.json..."
              echo "{}" > sentJobs.json
            fi
            
            if [ ! -f "subscribers.json" ]; then
              echo "ğŸ“„ Creating subscribers.json..."
              echo "[]" > subscribers.json
            fi

            # 5. Build and Run Docker
            echo "ğŸ³ Building Docker Image..."
            sudo docker build -t job-updates-bot .

            echo "ğŸ›‘ Stopping old container..."
            sudo docker stop job-bot-instance || true
            sudo docker rm job-bot-instance || true

            echo "ğŸš€ Starting new container..."
            sudo docker run -d \
              --name job-bot-instance \
              --restart always \
              -v $(pwd)/sentJobs.json:/usr/src/app/sentJobs.json \
              -v $(pwd)/subscribers.json:/usr/src/app/subscribers.json \
              --env TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
              job-updates-bot