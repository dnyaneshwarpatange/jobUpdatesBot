    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        # write the private key
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        # auto-add the host to known_hosts (avoids prompt)
        ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.AZURE_VM_HOST }} >> ~/.ssh/known_hosts

    - name: Copy artifact to Azure VM
      run: |
        scp -P ${{ secrets.SSH_PORT || 22 }} ../artifact/release.tar.gz \
            ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }}:~/app/

    - name: SSH and deploy
      run: |
        ssh -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }} << 'EOF'
          cd ~/app
          tar xzf release.tar.gz
          npm install --production
          pm2 restart index.js --name my-app || pm2 start index.js --name my-app
        EOF
